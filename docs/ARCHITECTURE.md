# LinkerHand C++ SDK æ¶æ„è®¾è®¡æ–‡æ¡£

> **æ–‡æ¡£ç‰ˆæœ¬**: 1.1
> **ç”Ÿæˆæ—¥æœŸ**: 2026-01-28
> **ç›®æ ‡è¯»è€…**: æ¶æ„å¸ˆã€é«˜çº§å¼€å‘è€…

---

## 1. é¡¹ç›®æ¦‚è§ˆ

### 1.1 é¡¹ç›®å®šä½ä¸æ ¸å¿ƒèŒè´£

LinkerHand C++ SDK æ˜¯ä¸€ä¸ªç”¨äºæ§åˆ¶ LinkerHand æœºæ¢°æ‰‹çš„åº•å±‚é€šä¿¡åº“ï¼Œé€šè¿‡ Linux SocketCAN æ¥å£ä¸ç¡¬ä»¶è¿›è¡Œé€šä¿¡ã€‚é¡¹ç›®æä¾›ï¼š

- **CAN æ€»çº¿é€šä¿¡æŠ½è±¡**: å°è£… SocketCAN æ“ä½œï¼Œæä¾›å‘å¸ƒ-è®¢é˜…æ¨¡å¼çš„æ¶ˆæ¯åˆ†å‘
- **æ‰‹å‹æ§åˆ¶ API**: æ”¯æŒ L6ï¼ˆå…­è‡ªç”±åº¦çµå·§æ‰‹ï¼‰å’Œ O6ï¼ˆç®€åŒ–ç‰ˆï¼‰ä¸¤ç§æ‰‹å‹
- **ä¼ æ„Ÿå™¨æ•°æ®é‡‡é›†**: è§’åº¦ã€åŠ›ä¼ æ„Ÿå™¨ã€æ‰­çŸ©ã€æ¸©åº¦ã€ç”µæµã€é€Ÿåº¦ã€æ•…éšœä¿¡æ¯

### 1.2 æŠ€æœ¯æ ˆä¸ä¾èµ–

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ |
|------|----------|
| è¯­è¨€æ ‡å‡† | C++17 |
| æ„å»ºç³»ç»Ÿ | CMake 3.16+ |
| çº¿ç¨‹åº“ | POSIX Threads (pthread) |
| CAN é€šä¿¡ | Linux SocketCAN |
| å¹³å°æ”¯æŒ | ä»… Linux |

### 1.3 ç›®å½•ç»“æ„ä¸æ¨¡å—åˆ’åˆ†

```
jiagou/
â”œâ”€â”€ include/linkerhand/
â”‚   â”œâ”€â”€ linkerhand.hpp          # ç»Ÿä¸€å…¥å£å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ can_dispatcher.hpp      # CAN æ¶ˆæ¯è°ƒåº¦å™¨
â”‚   â”œâ”€â”€ exceptions.hpp          # å¼‚å¸¸ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ iterable_queue.hpp      # å¯è¿­ä»£é˜»å¡é˜Ÿåˆ—
â”‚   â””â”€â”€ hand/
â”‚       â”œâ”€â”€ l6/                 # L6 æ‰‹å‹æ¨¡å—
â”‚       â”‚   â”œâ”€â”€ l6.hpp
â”‚       â”‚   â”œâ”€â”€ angle_manager.hpp
â”‚       â”‚   â”œâ”€â”€ force_sensor_manager.hpp
â”‚       â”‚   â”œâ”€â”€ torque_manager.hpp
â”‚       â”‚   â”œâ”€â”€ speed_manager.hpp
â”‚       â”‚   â”œâ”€â”€ temperature_manager.hpp
â”‚       â”‚   â”œâ”€â”€ current_manager.hpp
â”‚       â”‚   â””â”€â”€ fault_manager.hpp
â”‚       â””â”€â”€ o6/                 # O6 æ‰‹å‹æ¨¡å—
â”‚           â”œâ”€â”€ o6.hpp
â”‚           â”œâ”€â”€ angle_manager.hpp
â”‚           â”œâ”€â”€ torque_manager.hpp
â”‚           â”œâ”€â”€ speed_manager.hpp
â”‚           â””â”€â”€ temperature_manager.hpp
â””â”€â”€ src/
    â”œâ”€â”€ can_dispatcher.cpp
    â””â”€â”€ hand/
        â”œâ”€â”€ common.hpp          # å†…éƒ¨å…±äº«å·¥å…·
        â”œâ”€â”€ l6/*.cpp
        â””â”€â”€ o6/*.cpp
```

---

## 2. æ ¸å¿ƒæ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Application Layer                           â”‚
â”‚                     (L6 / O6 Hand Interface)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    L6 / O6 (Facade)                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚  â”‚  â”‚ Angle   â”‚ â”‚ Force   â”‚ â”‚ Torque  â”‚ â”‚ Temp    â”‚  ...      â”‚   â”‚
â”‚  â”‚  â”‚ Manager â”‚ â”‚ Sensor  â”‚ â”‚ Manager â”‚ â”‚ Manager â”‚           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚  â”‚       â”‚           â”‚           â”‚           â”‚                 â”‚   â”‚
â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚   â”‚
â”‚  â”‚                           â”‚                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚ subscribe/send                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  CANMessageDispatcher                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ recv_thread_ â”‚â”€â”€â”€â–¶â”‚ subscribers_  â”‚â”€â”€â”€â–¶â”‚  Callbacks    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ (poll loop)  â”‚    â”‚ (vector)      â”‚    â”‚  (dispatch)   â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚         â–²                                                     â”‚   â”‚
â”‚  â”‚         â”‚ read/write                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            â”‚                  System Layer                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚  â”‚  Linux SocketCAN  â”‚                                              â”‚
â”‚  â”‚   (socket_fd_)    â”‚                                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒç±»èŒè´£ä¸åä½œå…³ç³»

| ç±»å | èŒè´£ | å…³é”®ä¾èµ– |
|------|------|----------|
| `L6` / `O6` | å¤–è§‚ç±»ï¼Œèšåˆæ‰€æœ‰ Managerï¼Œç®¡ç†æ•´ä½“ç”Ÿå‘½å‘¨æœŸ | `CANMessageDispatcher` |
| `CANMessageDispatcher` | CAN æ¶ˆæ¯æ”¶å‘ä¸åˆ†å‘ï¼Œç®¡ç†æ¥æ”¶çº¿ç¨‹ | Linux SocketCAN |
| `*Manager` | ç‰¹å®šä¼ æ„Ÿå™¨/æ‰§è¡Œå™¨çš„æ•°æ®ç®¡ç†ï¼Œæä¾›åŒæ­¥/å¼‚æ­¥/æµå¼API | `CANMessageDispatcher` |
| `IterableQueue<T>` | çº¿ç¨‹å®‰å…¨çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ”¯æŒ range-based for è¿­ä»£ | - |

### 2.3 æ•°æ®æµå‘

```
[ç¡¬ä»¶] â”€â”€CAN Frameâ”€â”€â–¶ [SocketCAN] â”€â”€read()â”€â”€â–¶ [recv_thread_]
                                                    â”‚
                                                    â–¼
                                            [on_message å›è°ƒ]
                                                    â”‚
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â–¼                      â–¼
                                  [latest_data_]        [streaming_queue]
                                  (ç¼“å­˜æœ€æ–°å€¼)           (æµå¼æ•°æ®é˜Ÿåˆ—)
                                         â”‚                      â”‚
                                         â–¼                      â–¼
                                [get_current_*()]      [stream() è¿­ä»£å™¨]
```

---

## 3. ç”Ÿå‘½å‘¨æœŸå¥‘çº¦

### 3.1 èµ„æºç®¡ç†æ¨¡å‹

#### 3.1.1 `close()` / `stop()` / ææ„å‡½æ•° è¯­ä¹‰åŒºåˆ†

| æ–¹æ³• | è¯­ä¹‰ | å¹‚ç­‰æ€§ | å®ç°ä½ç½® |
|------|------|--------|----------|
| `L6::close()` / `O6::close()` | åœæ­¢æ‰€æœ‰æµã€å…³é—­ dispatcher | âœ… å¹‚ç­‰ | `src/hand/l6/l6.cpp`, `src/hand/o6/o6.cpp` |
| `CANMessageDispatcher::stop()` | åœæ­¢æ¥æ”¶çº¿ç¨‹ã€å…³é—­ socket | âœ… å¹‚ç­‰ | `src/can_dispatcher.cpp` |
| `*Manager::stop_streaming()` | åœæ­¢æµå¼æ•°æ®é‡‡é›† | âœ… å¹‚ç­‰ | `src/hand/**/**_manager.cpp` |
| ææ„å‡½æ•° | è°ƒç”¨ `close()`/`stop()`ï¼Œåæ‰å¼‚å¸¸ | N/A | å„ç±»ææ„ |

#### 3.1.2 å¹‚ç­‰æ€§å®ç°æœºåˆ¶

**L6/O6 çš„ `close()` å®ç°**ï¼ˆç¤ºæ„ï¼‰:
```cpp
void L6::close() {
  if (closed_.exchange(true, std::memory_order_acq_rel)) {  // å¹‚ç­‰ + çº¿ç¨‹å®‰å…¨
    return;
  }
  // ... åœæ­¢å„ä¸ªæµ ...
  dispatcher_.stop();
}
```

`closed_` ä¸º `std::atomic<bool>`ï¼Œå› æ­¤ `close()` å¯å®‰å…¨å¹¶å‘è°ƒç”¨ï¼Œå¹¶ä¸”æ»¡è¶³å¹‚ç­‰æ€§ã€‚

**CANMessageDispatcher çš„ `stop()` å®ç°** (`can_dispatcher.cpp:117-130`):
```cpp
void CANMessageDispatcher::stop() {
  const bool was_running = running_.exchange(false);  // åŸå­äº¤æ¢ï¼Œä¿è¯å¹‚ç­‰
  if (was_running && recv_thread_.joinable()) {
    recv_thread_.join();
  }
  // ...
}
```

### 3.2 çŠ¶æ€æœºå®šä¹‰

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚              L6 / O6 çŠ¶æ€å›¾                   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Created â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Running  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Closed  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                    â”‚                     â”‚
          â”‚ æ„é€ å‡½æ•°           â”‚ close()             â”‚ ä»»ä½•æ–¹æ³•è°ƒç”¨
          â”‚                    â”‚ æˆ–ææ„              â”‚
          â–¼                    â–¼                     â–¼
     dispatcher_        stop_streaming()      ensure_open() æŠ›å‡º
     åˆå§‹åŒ–å®Œæˆ          + dispatcher_.stop()   StateErrorï¼ˆæˆ– dispatcher stop åçš„çŠ¶æ€é”™è¯¯ï¼‰
```

### 3.3 å¼‚å¸¸åè¡Œä¸º

#### 3.3.1 `close()` åè°ƒç”¨å…¶ä»–æ–¹æ³•çš„ç»Ÿä¸€è¡Œä¸º

**å½“å‰å®ç°è¡Œä¸º**:

| ç±» | closeåè°ƒç”¨è¡Œä¸º | å®ç°æ–¹å¼ |
|----|----------------|----------|
| `L6` / `O6` | `is_closed()==true`ï¼›`close()` å¹‚ç­‰ï¼›å…¶æˆå‘˜ Manager è‹¥è§¦å‘ CAN IO å°†æŠ› `StateError` | `closed_` åŸå­ï¼›dispatcher `send()` çŠ¶æ€æ£€æŸ¥ |
| `CANMessageDispatcher` | `send()` åœ¨ `stop()` åæŠ› `StateError("CAN dispatcher is stopped")`ï¼›`stop()` å¹‚ç­‰ | `running_` åŸå­ + `socket_mutex_` åŒé‡æ£€æŸ¥ |
| `*Manager` | `get_current_*()` ä»å¯è¯»å–ç¼“å­˜ï¼›æ¶‰åŠ CAN IO çš„æ“ä½œä¼šåœ¨ dispatcher stop åæŠ› `StateError` | ä¾èµ– dispatcher çš„çŠ¶æ€æ£€æŸ¥ + å„ Manager å†…éƒ¨çŠ¶æ€æœº |

**`ensure_open()` å®ç°**ï¼ˆç¤ºæ„ï¼‰:
```cpp
void L6::ensure_open() const {
  if (closed_.load(std::memory_order_acquire)) {
    throw StateError(
        "L6 interface is closed. Create a new instance or use context manager.");
  }
}
```

**è¯´æ˜**: å½“å‰ `L6/O6` å°†å„ Manager ä½œä¸ºå…¬æœ‰æˆå‘˜ç›´æ¥æš´éœ²ï¼Œå› æ­¤ `ensure_open()` ä¸ä¼šè‡ªåŠ¨è¦†ç›–åˆ°æ‰€æœ‰ Manager APIï¼›close åçš„â€œçŠ¶æ€çº¦æŸâ€ä¸»è¦ç”± `CANMessageDispatcher::send()` çš„çŠ¶æ€æ£€æŸ¥ä¸å„ Manager çš„å†…éƒ¨çŠ¶æ€æœºæä¾›ã€‚

---

## 4. å¹¶å‘æ¨¡å‹ä¸çº¿ç¨‹å®‰å…¨

### 4.1 çº¿ç¨‹æ¨¡å‹

ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨çš„çº¿ç¨‹ï¼š

| çº¿ç¨‹ | æ‰€å±ç»„ä»¶ | èŒè´£ | ç”Ÿå‘½å‘¨æœŸ |
|------|----------|------|----------|
| `recv_thread_` | `CANMessageDispatcher` | è½®è¯¢ CAN socketï¼Œåˆ†å‘æ¶ˆæ¯ | æ„é€ â†’stop() |
| `streaming_thread` | å„ `*Manager::Impl` | å‘¨æœŸæ€§å‘é€ä¼ æ„Ÿå™¨è¯·æ±‚ | stream()â†’stop_streaming() |
| `aggregation_thread` | `ForceSensorManager::Impl` | èšåˆäº”æŒ‡æ•°æ® | stream()â†’stop_streaming() |
| `reader_threads` | `ForceSensorManager::Impl` | ä»å•æŒ‡é˜Ÿåˆ—è¯»å–æ•°æ® | éš aggregation_thread |

### 4.2 å›è°ƒæ‰§è¡Œä¸Šä¸‹æ–‡

**å…³é”®ä»£ç **ï¼ˆç¤ºæ„ï¼‰:
```cpp
// åœ¨ recv_thread_ çº¿ç¨‹ä¸­æ‰§è¡Œ
std::vector<std::shared_ptr<SubscriberState>> subscribers_copy;
{
  std::lock_guard<std::mutex> lock(subscribers_mutex_);
  subscribers_copy = subscribers_;  // å¤åˆ¶å¿«ç…§
}

for (const auto& subscriber : subscribers_copy) {
  if (!subscriber->try_enter()) {
    continue;  // å·²å–æ¶ˆè®¢é˜…æˆ–æ­£åœ¨ææ„
  }
  try {
    subscriber->callback(msg);  // å›è°ƒåœ¨ recv_thread_ ä¸­æ‰§è¡Œ
  } catch (const std::exception& e) {
    std::cerr << "CANMessageDispatcher callback error: " << e.what() << "\n";
  }
  subscriber->exit();
  // ...
}
```

#### å›è°ƒè¯­ä¹‰æ€»ç»“

| å±æ€§ | å€¼ | è¯´æ˜ |
|------|-----|------|
| **æ‰§è¡Œçº¿ç¨‹** | `recv_thread_` | æ‰€æœ‰å›è°ƒåœ¨åŒä¸€çº¿ç¨‹é¡ºåºæ‰§è¡Œ |
| **æ˜¯å¦å…è®¸é˜»å¡** | âš ï¸ ä¸å»ºè®® | é˜»å¡ä¼šå»¶è¿Ÿå…¶ä»–å›è°ƒå’Œåç»­æ¶ˆæ¯å¤„ç† |
| **å¼‚å¸¸å¤„ç†** | æ•è·å¹¶è®°å½•åˆ° stderr | ä¸ä¼šä¸­æ–­å…¶ä»–å›è°ƒ |

### 4.3 è®¢é˜…/å–æ¶ˆè®¢é˜…çš„å¹¶å‘ç­–ç•¥

#### 4.3.1 `subscribe()` å®ç°ï¼ˆ`src/can_dispatcher.cpp`ï¼‰

```cpp
std::size_t CANMessageDispatcher::subscribe(Callback callback) {
  std::lock_guard<std::mutex> lock(subscribers_mutex_);
  const std::size_t id = next_subscription_id_++;
  subscribers_.push_back(std::make_shared<SubscriberState>(id, std::move(callback)));
  return id;
}
```

#### 4.3.2 `unsubscribe()` å®ç°ï¼ˆ`src/can_dispatcher.cpp`ï¼‰

```cpp
void CANMessageDispatcher::unsubscribe(std::size_t subscription_id) {
  std::shared_ptr<SubscriberState> subscriber;
  {
    std::lock_guard<std::mutex> lock(subscribers_mutex_);
    // find + erase
  }
  if (!subscriber) {
    return;
  }
  subscriber->deactivate();

  // é recv_thread_ è°ƒç”¨æ—¶ï¼šç­‰å¾…å›è°ƒâ€œå®Œå…¨é€€å‡ºâ€
  if (!on_recv_thread) {
    subscriber->wait_for_idle();
  }
}
```

#### å¹¶å‘å®‰å…¨æ€§åˆ†æ

| æ“ä½œ | çº¿ç¨‹å®‰å…¨ | å¯åœ¨å›è°ƒä¸­è°ƒç”¨ | è¯´æ˜ |
|------|----------|----------------|------|
| `subscribe()` | âœ… | âœ… | ä½¿ç”¨ mutex ä¿æŠ¤ |
| `unsubscribe()` | âœ… | âœ… | å–æ¶ˆè®¢é˜…åï¼ˆé recv_thread_ è°ƒç”¨æ—¶ï¼‰ä¼šç­‰å¾…å›è°ƒé€€å‡º |

**å¿«ç…§æ¨¡å¼çš„ä¼˜ç‚¹**: `recv_thread_` åœ¨åˆ†å‘å‰å¤åˆ¶ `subscribers_`ï¼Œé‡Šæ”¾é”åå†æ‰§è¡Œå›è°ƒï¼Œå…è®¸å›è°ƒä¸­å®‰å…¨è°ƒç”¨ `subscribe`/`unsubscribe`ã€‚

**æ–°å¢çº¦æŸ**: å½“ `unsubscribe()` åœ¨ `recv_thread_`ï¼ˆå³å›è°ƒæ ˆå†…ï¼‰è¢«è°ƒç”¨æ—¶ï¼Œä¸ºé¿å…è‡ªé”/æ­»é”ï¼Œä¸ä¼šç­‰å¾… `wait_for_idle()`ï¼›å› æ­¤ä¸åº”åœ¨å›è°ƒæ ˆå†…è§¦å‘â€œé”€æ¯å›è°ƒç›®æ ‡å¯¹è±¡â€çš„è¡Œä¸ºï¼ˆä¾‹å¦‚ç›´æ¥ææ„æŒæœ‰è¯¥å›è°ƒçš„ Managerï¼‰ã€‚

### 4.4 åœæ­¢æ—¶çš„ç«æ€å¤„ç†

#### 4.4.1 `stop()` ä¸å›è°ƒçš„åè°ƒ

**å½“å‰å®ç°åˆ†æ** (`can_dispatcher.cpp:117-130`):

```cpp
void CANMessageDispatcher::stop() {
  const bool was_running = running_.exchange(false);  // 1. è®¾ç½®åœæ­¢æ ‡å¿—
  if (was_running && recv_thread_.joinable()) {
    recv_thread_.join();  // 2. ç­‰å¾…çº¿ç¨‹ç»“æŸ
  }
  // 3. å…³é—­ socket
}
```

**`recv_loop()` çš„é€€å‡ºæœºåˆ¶**:
```cpp
while (running_.load()) {  // æ£€æŸ¥åœæ­¢æ ‡å¿—
  const int ret = ::poll(&pfd, 1, 10);  // 10ms è¶…æ—¶
  // ...
}
```

**âš ï¸ ç«æ€çª—å£**: åœ¨ `running_.exchange(false)` åï¼Œ`recv_thread_` å¯èƒ½ä»åœ¨æ‰§è¡Œå›è°ƒï¼ˆå› ä¸ºæ£€æŸ¥ `running_` åœ¨å¾ªç¯å¼€å¤´ï¼‰ã€‚`join()` ä¿è¯ç­‰å¾…å›è°ƒå®Œæˆã€‚

#### 4.4.2 Manager çš„ `stop_streaming()` å®ç°

ä»¥ `AngleManager::Impl::stop_streaming()` ä¸ºä¾‹ï¼ˆç¤ºæ„ï¼‰:

```cpp
void stop_streaming() {
  std::lock_guard<std::mutex> lock(streaming_mutex);
  if (!streaming_queue.has_value()) {
    return;  // å¹‚ç­‰ä¿æŠ¤
  }
  streaming_running.store(false);  // 1. è®¾ç½®åœæ­¢æ ‡å¿—
  streaming_queue->close();        // 2. å…³é—­é˜Ÿåˆ—ï¼ˆå”¤é†’é˜»å¡æ¶ˆè´¹è€…ï¼‰
  streaming_queue.reset();         // 3. æ¸…é™¤å†…éƒ¨å¼•ç”¨
  if (streaming_thread.joinable()) {
    streaming_thread.join();       // 4. ç­‰å¾…çº¿ç¨‹ç»“æŸ
  }
}
```

**è®¾è®¡äº®ç‚¹**:
- `stop_streaming()` å¹‚ç­‰ï¼šå…è®¸å¤šæ¬¡è°ƒç”¨ï¼›ææ„è·¯å¾„åŒæ ·å¯å®‰å…¨å¤ç”¨
- `close()` ä¿è¯å”¤é†’é˜Ÿåˆ—æ¶ˆè´¹è€…ï¼Œé¿å…â€œææ„æ—¶æ¶ˆè´¹è€…æ°¸è¿œé˜»å¡â€

**è¡¥å……è¯´æ˜**:
- `stream()` ä¼šå…ˆæ„é€ å¹¶è¿”å›é˜Ÿåˆ—å¯¹è±¡ï¼ˆå€¼è¯­ä¹‰ã€å…±äº«åº•å±‚çŠ¶æ€ï¼‰ï¼Œé¿å…å¹¶å‘ `stop_streaming()` å¯¼è‡´çš„è¿”å›å¼•ç”¨å¤±æ•ˆé—®é¢˜ã€‚
- streaming çº¿ç¨‹ä½¿ç”¨ `interval_ms` çš„å€¼æ‹·è´ï¼Œä¸ä¾èµ–å…±äº«çš„ `optional` çŠ¶æ€ï¼Œé™ä½ç«æ€ä¸çŠ¶æ€æ£€æŸ¥å¤æ‚åº¦ã€‚

#### 4.4.3 ææ„ä¸å›è°ƒåè°ƒï¼ˆå·²ä¿®å¤ï¼‰

å†å²ç‰ˆæœ¬ä¸­ï¼Œé‡‡ç”¨â€œå¿«ç…§åˆ†å‘â€ä¼šå¸¦æ¥ä¸€ä¸ªå…¸å‹é£é™©ï¼š`unsubscribe()` è¿”å›æ—¶å¹¶ä¸èƒ½ä¿è¯å›è°ƒå·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œä»è€Œå¯¼è‡´ææ„æœŸé—´ UAFã€‚

å½“å‰å®ç°é€šè¿‡ä¸ºæ¯ä¸ªè®¢é˜…è€…å¼•å…¥ç‹¬ç«‹çš„ `SubscriberState`ï¼ˆ`active` + `in_flight` è®¡æ•°ï¼‰è§£å†³è¯¥é—®é¢˜ï¼š

- `recv_thread_` åœ¨æ‰§è¡Œå›è°ƒå‰è°ƒç”¨ `try_enter()`ï¼šåªæœ‰å½“è®¢é˜…ä»å¤„äº active çŠ¶æ€æ‰å…è®¸è¿›å…¥ï¼Œå¹¶å°† `in_flight` è®¡æ•° +1
- å›è°ƒæ‰§è¡Œå®Œæ¯•åè°ƒç”¨ `exit()`ï¼š`in_flight` è®¡æ•° -1ï¼Œå¹¶åœ¨å½’é›¶æ—¶å”¤é†’ç­‰å¾…è€…
- `unsubscribe()`ï¼šå…ˆä»è®¢é˜…åˆ—è¡¨ç§»é™¤ï¼Œå† `deactivate()`ï¼Œæœ€åï¼ˆé `recv_thread_` è°ƒç”¨æ—¶ï¼‰`wait_for_idle()` ç­‰å¾…æ‰€æœ‰ in-flight å›è°ƒé€€å‡º

å› æ­¤ï¼Œ`Manager::Impl` ææ„ä¸­è°ƒç”¨ `dispatcher.unsubscribe(subscription_id)` å¯ä»¥åœ¨å¹¶å‘åœºæ™¯ä¸‹é¿å…å›è°ƒä»åœ¨æ‰§è¡Œæ—¶é‡Šæ”¾ `Impl` å†…éƒ¨çŠ¶æ€ã€‚

**é‡è¦é™åˆ¶**: å½“ `unsubscribe()` åœ¨ `recv_thread_`ï¼ˆå›è°ƒæ ˆå†…ï¼‰è¢«è°ƒç”¨æ—¶ä¸ä¼šç­‰å¾… `wait_for_idle()`ï¼Œä»¥é¿å…è‡ªé”/æ­»é”ï¼›æ­¤æ—¶ä¸åº”åœ¨åŒä¸€å›è°ƒæ ˆå†…è§¦å‘ç›¸å…³å¯¹è±¡çš„ææ„ã€‚

---

## 5. å…³é”® API ä½¿ç”¨æŒ‡å—

### 5.1 æ ¸å¿ƒç±»çš„æ„é€ ä¸åˆå§‹åŒ–

```cpp
#include <linkerhand/linkerhand.hpp>

// åˆ›å»º L6 æ‰‹å‹æ§åˆ¶å™¨
// å‚æ•°: side ("left"/"right"), interface_name ("can0"), interface_type ("socketcan")
linkerhand::L6 hand("left", "can0");

// åˆ›å»º O6 æ‰‹å‹æ§åˆ¶å™¨
linkerhand::O6 hand_o6("right", "can1");
```

### 5.2 å…¸å‹ä½¿ç”¨æµç¨‹

#### 5.2.1 åŒæ­¥è·å–æ•°æ®

```cpp
// é˜»å¡è·å–è§’åº¦æ•°æ®ï¼Œè¶…æ—¶ 100ms
try {
  auto angles = hand.angle.get_angles_blocking(100);
  // angles.angles: std::array<int, 6>
  // angles.timestamp: double (Unix æ—¶é—´æˆ³)
} catch (const linkerhand::TimeoutError& e) {
  // è¶…æ—¶å¤„ç†
}

// è·å–ç¼“å­˜çš„æœ€æ–°å€¼ï¼ˆéé˜»å¡ï¼‰
if (auto angles = hand.angle.get_current_angles()) {
  // ä½¿ç”¨ angles->angles
}
```

#### 5.2.2 æµå¼æ•°æ®é‡‡é›†

```cpp
// å¯åŠ¨æµï¼Œé—´éš” 50msï¼Œé˜Ÿåˆ—å®¹é‡ 100
auto queue = hand.angle.stream(50, 100);

// range-based for è¿­ä»£ï¼ˆé˜»å¡ï¼‰
for (const auto& data : queue) {
  // å¤„ç† data
  if (should_stop) break;
}

// åœæ­¢æµï¼ˆæˆ–è®© queue ç¦»å¼€ä½œç”¨åŸŸï¼‰
hand.angle.stop_streaming();
```

#### 5.2.3 è®¾ç½®è§’åº¦

```cpp
// ä½¿ç”¨ std::array
hand.angle.set_angles({128, 128, 128, 128, 128, 128});

// ä½¿ç”¨ std::vector
std::vector<int> angles = {100, 100, 100, 100, 100, 100};
hand.angle.set_angles(angles);
```

### 5.3 é”™è¯¯å¤„ç†çº¦å®š

| å¼‚å¸¸ç±»å‹ | è§¦å‘åœºæ™¯ |
|----------|----------|
| `LinkerHandError` | æ‰€æœ‰å¼‚å¸¸çš„åŸºç±» |
| `TimeoutError` | é˜»å¡æ“ä½œè¶…æ—¶ |
| `CANError` | CAN é€šä¿¡é”™è¯¯ |
| `ValidationError` | å‚æ•°æ ¡éªŒå¤±è´¥ |
| `StateError` | çŠ¶æ€ä¸æ­£ç¡®ï¼ˆå¦‚é‡å¤è°ƒç”¨ stream()ï¼‰ |
| `QueueFull` / `QueueEmpty` | é˜Ÿåˆ—æ“ä½œå¼‚å¸¸ |
| `StopIteration` | è¿­ä»£å™¨ç»“æŸæ ‡è®° |

---

## 6. è®¾è®¡å†³ç­–ä¸æƒè¡¡

### 6.1 è®¾è®¡å–èˆè¯´æ˜

| å†³ç­– | ç†ç”± | æƒè¡¡ |
|------|------|------|
| Pimpl æ¨¡å¼ | éšè—å®ç°ç»†èŠ‚ï¼ŒABI ç¨³å®š | å¢åŠ é—´æ¥è°ƒç”¨å¼€é”€ |
| å¿«ç…§åˆ†å‘ + in-flight åŒæ­¥ | å…è®¸å›è°ƒä¸­ä¿®æ”¹è®¢é˜…ï¼›é¿å…å–æ¶ˆè®¢é˜…/ææ„æœŸé—´ UAF | `unsubscribe()` åœ¨é recv_thread_ è°ƒç”¨æ—¶å¯èƒ½é˜»å¡ç­‰å¾…å›è°ƒé€€å‡ºï¼›å¢åŠ å°‘é‡åŸå­/å¼•ç”¨è®¡æ•°å¼€é”€ |
| å…±äº«çŠ¶æ€ Queue | `IterableQueue` å¯å¤åˆ¶ï¼Œæ–¹ä¾¿ä¼ é€’ | éœ€è¦ `shared_ptr`ï¼Œå¢åŠ å¼•ç”¨è®¡æ•°å¼€é”€ |
| ä»… Linux æ”¯æŒ | ç®€åŒ–å®ç°ï¼Œä¸“æ³¨ SocketCAN | æ— æ³•åœ¨é Linux å¹³å°ä½¿ç”¨ |

### 6.2 å·²çŸ¥é™åˆ¶ä¸æ½œåœ¨é£é™©ç‚¹

#### âœ… å·²ä¿®å¤é—®é¢˜

| ID | é—®é¢˜æè¿° | ä¿®å¤æ‘˜è¦ |
|----|----------|----------|
| **F1** | `close()` å¹‚ç­‰ä½†å­˜åœ¨æ•°æ®ç«äº‰é£é™© | `L6/O6::closed_` ä½¿ç”¨ `std::atomic<bool>` + `exchange()` |
| **F2** | `unsubscribe()` ä¸å›è°ƒå¹¶å‘å¯¼è‡´ææ„æœŸé—´ UAF | `SubscriberState(active + in_flight)`ï¼›é recv_thread_ è°ƒç”¨ `unsubscribe()` ä¼šç­‰å¾…å›è°ƒé€€å‡º |
| **F3** | dispatcher stop å send è¡Œä¸ºæœªå®šä¹‰ | `CANMessageDispatcher::send()` å¯¹ `running_` ä¸ `socket_fd_` åšçŠ¶æ€æ£€æŸ¥å¹¶æŠ› `StateError` |
| **F4** | `stream()` / `stop_streaming()` å¹¶å‘å­˜åœ¨è¿”å›å¼•ç”¨å¤±æ•ˆä¸ç«æ€çª—å£ | `stream()` è¿”å›é˜Ÿåˆ—å€¼å¯¹è±¡ï¼›streaming çº¿ç¨‹ä½¿ç”¨ `interval_ms` å€¼æ‹·è´ï¼›`stop_streaming()` å…³é—­é˜Ÿåˆ—å¹¶ join çº¿ç¨‹ |
| **F5** | `ForceSensorManager` èšåˆçº¿ç¨‹è¶…æ—¶é€€å‡ºå¯¼è‡´é˜Ÿåˆ—ä¸å…³é—­/æ½œåœ¨ UAF | èšåˆå¾ªç¯å¯¹è¶…æ—¶é‡‡ç”¨ continueï¼›intermediate queue ä½¿ç”¨å…±äº«æ‰€æœ‰æƒå¹¶åœ¨é€€å‡ºæ—¶å…³é—­ |

#### ğŸŸ¡ ä¸­ç­‰é—®é¢˜

| ID | é—®é¢˜æè¿° | å½±å“ | å»ºè®®ä¿®å¤ |
|----|----------|------|----------|
| **M1** | `ensure_open()` æ— æ³•è¦†ç›–æ‰€æœ‰å…¬å¼€ APIï¼ˆManager ä½œä¸ºå…¬æœ‰æˆå‘˜æš´éœ²ï¼‰ | close åçš„é”™è¯¯è¯­ä¹‰ä¸»è¦ç”± dispatcher/Manager å†…éƒ¨æä¾›ï¼ŒFacade å±‚ç¼ºå°‘ç»Ÿä¸€å…¥å£ä¸ä¸€è‡´é”™è¯¯ä¿¡æ¯ | è®© Facade æä¾›å°è£…æ–¹æ³•æˆ–è®© Manager æŒæœ‰ Facade çš„å…±äº«çŠ¶æ€è¿›è¡Œæ£€æŸ¥ |
| **M2** | å›è°ƒé˜»å¡ä¼šå½±å“æ•´ä¸ªæ¶ˆæ¯åˆ†å‘ | æ€§èƒ½ä¸‹é™ã€æ¶ˆæ¯å †ç§¯ | æ–‡æ¡£è¯´æ˜ï¼›è€ƒè™‘å¼‚æ­¥åˆ†å‘ |
| **M3** | å¯¹è±¡ç”Ÿå‘½å‘¨æœŸä¸å¹¶å‘è°ƒç”¨ï¼ˆå°¤å…¶æ˜¯é˜»å¡ APIï¼‰ | å¹¶å‘ææ„ä¸æ­£åœ¨æ‰§è¡Œçš„æˆå‘˜è°ƒç”¨å±äºè°ƒç”¨æ–¹è´£ä»» | æ–‡æ¡£æ˜ç¡®çº¦æŸï¼›å¿…è¦æ—¶å¼•å…¥â€œå–æ¶ˆé˜»å¡ç­‰å¾…â€çš„æœºåˆ¶ |

#### ğŸŸ¢ è½»å¾®é—®é¢˜

| ID | é—®é¢˜æè¿° | å½±å“ | å»ºè®®ä¿®å¤ |
|----|----------|------|----------|
| **L1** | `poll()` è¶…æ—¶ 10ms ç¡¬ç¼–ç  | ä¸å¯é…ç½® | æå–ä¸ºæ„é€ å‚æ•° |
| **L2** | é”™è¯¯ä¿¡æ¯è¾“å‡ºåˆ° stderr | æ— æ³•æ•è·æˆ–å®šåˆ¶ | å¼•å…¥æ—¥å¿—å›è°ƒ |

### 6.3 æ‰©å±•æ€§è€ƒé‡

#### 6.3.1 æ·»åŠ æ–°çš„ Manager

1. åœ¨ `include/linkerhand/hand/{version}/` ä¸‹åˆ›å»ºå¤´æ–‡ä»¶
2. å®šä¹‰ `*Data` ç»“æ„ä½“å’Œ `*Manager` ç±»
3. åœ¨ `src/hand/{version}/` ä¸‹å®ç° Impl
4. åœ¨ `L6`/`O6` ç±»ä¸­æ·»åŠ æˆå‘˜å¹¶åˆå§‹åŒ–

#### 6.3.2 æ”¯æŒæ–°çš„ CAN æ¥å£ç±»å‹

å½“å‰ä»…æ”¯æŒ `socketcan`ã€‚æ‰©å±•éœ€è¦ï¼š

1. ä¿®æ”¹ `CANMessageDispatcher` æ„é€ å‡½æ•°çš„ `interface_type` æ£€æŸ¥
2. åœ¨ `#ifdef` å—ä¸­æ·»åŠ æ–°çš„åˆå§‹åŒ–é€»è¾‘
3. è€ƒè™‘æŠ½è±¡å‡º `CANBackend` æ¥å£

#### 6.3.3 è·¨å¹³å°æ”¯æŒ

å½“å‰é Linux å¹³å°ä¼šï¼š
- æ„é€ æ—¶æŠ›å‡º `CANError`
- `stop()` ç›´æ¥è¿”å›ï¼ˆæ— æ“ä½œï¼‰
- `send()` ç›´æ¥æŠ›å‡º `CANError`ï¼ˆSocketCAN ä»…æ”¯æŒ Linuxï¼‰

å»ºè®®å¼•å…¥æ¨¡æ‹Ÿåç«¯æˆ–æŠ½è±¡æ¥å£ä»¥æ”¯æŒå•å…ƒæµ‹è¯•ã€‚

---

## é™„å½• A: ç±»å›¾ (UML)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       L6/O6         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚- dispatcher_        â”‚
â”‚- closed_            â”‚
â”‚+ angle: Manager     â”‚
â”‚+ torque: Manager    â”‚
â”‚+ ...                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚+ close()            â”‚
â”‚+ is_closed()        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ owns
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    CANMessageDispatcher     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚- socket_fd_                 â”‚
â”‚- running_: atomic<bool>     â”‚
â”‚- recv_thread_               â”‚
â”‚- subscribers_: vector       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚+ subscribe(cb) â†’ id         â”‚
â”‚+ unsubscribe(id)            â”‚
â”‚+ send(msg)                  â”‚
â”‚+ stop()                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â–²
          â”‚ references
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    *Manager         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚- impl_: unique_ptr  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚+ get_*_blocking()   â”‚
â”‚+ get_current_*()    â”‚
â”‚+ stream()           â”‚
â”‚+ stop_streaming()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é™„å½• B: æ¶ˆæ¯åè®®æ‘˜è¦

| åŠŸèƒ½ | CAN ID (left/right) | CMD Byte | æ•°æ®æ ¼å¼ |
|------|---------------------|----------|----------|
| è§’åº¦æ§åˆ¶/æŸ¥è¯¢ | 0x28 / 0x27 | 0x01 | [cmd, angle1..6] |
| åŠ›ä¼ æ„Ÿå™¨ (thumb) | 0x28 / 0x27 | 0xB1 | å¤šå¸§åè®® (12 frames Ã— 6 bytes) |
| åŠ›ä¼ æ„Ÿå™¨ (index) | 0x28 / 0x27 | 0xB2 | åŒä¸Š |
| ... | ... | ... | ... |

---

## é™„å½• C: ä¿®æ”¹å»ºè®®ä¼˜å…ˆçº§

1. **çŸ­æœŸæ”¹è¿› (M3)**: æ˜ç¡®å¹¶å¼ºåŒ–â€œå¯¹è±¡ç”Ÿå‘½å‘¨æœŸä¸å¹¶å‘è°ƒç”¨â€çš„å¥‘çº¦ï¼Œå¿…è¦æ—¶å¼•å…¥å–æ¶ˆé˜»å¡ç­‰å¾…æœºåˆ¶
2. **çŸ­æœŸæ”¹è¿› (M1, M2)**: æå‡ Facade å±‚ä¸€è‡´æ€§ä¸å›è°ƒä¾§çº¦æŸè¯´æ˜
3. **é•¿æœŸä¼˜åŒ– (L1, L2)**: æ”¹å–„å¯ç»´æŠ¤æ€§å’Œå¯é…ç½®æ€§

---

*æ–‡æ¡£ç»“æŸ*
